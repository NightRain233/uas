# 启动规则

## 关于主机的定义

0. 关于主机的定义
- 健康主机
  - 定义：正常运行且通过了健康检查的主机。
  - 特征：
    - 主机状态为 "正常"
    - 通过 ULB的健康检查
    
- 初始化主机
  - 定义：正在启动或配置中，或者刚刚创建但尚未完全就绪的主机
  - 特征：
    1. 主机状态为 "初始化中"
    2. 主机状态为 "正常" 尚未通过健康检查、创建时间在预定义的冷却时间内

- 不健康主机
  - 定义：已经完成初始化但未能通过健康检查的主机。
  - 特征：
    - 主机状态为 "正常"
    - 未通过 ULB 健康检查切且创建时间已超过预定义的冷却时间

## 主机数量区间规则
- 目标1（扩容逻辑）：健康主机 + 初始化主机 >= 最小值
- 目标 2（缩容逻辑）：健康主机 + 初始化主机 + 不健康主机 <= 最大值
- 如需扩容（触发目标 1），检查扩容后的主机数是否满足目标 2，不满足则取消扩容

## CPU规则
- 仅在 CPU 指标计算结果表明需要变更主机数时进行处理
- 确保变更后的主机数不违反最大最小值限制
- 伸缩个数的计算公式delta = (AvgGroupCPU * ActiveCount / cpuExpected) - ActiveCount
  - 若需扩容（delta > 0），则需要排除初始化主机 delta = max(delta - InitCount, 0)
  - 扩
  缩容(delta != 0)不超过主机数量区间

## 健康规则
1. 每两分钟记录一次不健康主机数
2. 连续三次记录均不健康的主机将被移除

注意：
1. 开启移除保护的主机不会被规则删除
2. 缩容时，优先移除最早创建的主机和伸缩组自动创建的主机



